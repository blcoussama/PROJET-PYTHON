{% extends "base.html" %}

{% block content %}
<article
    style="background:#fff; border-radius:6px; box-shadow:0 2px 5px rgba(0,0,0,0.1); overflow:hidden; margin-bottom:2rem;">
    {% if article.image_url %}
    <img src="{{ article.image_url }}" alt="{{ article.title }}"
        style="width:100%; height:300px; object-fit:cover; display:block;">
    {% endif %}
    <div style="padding:1.5rem;">
        <header style="margin-bottom:1rem;">
            <h1 style="margin-bottom:.5rem; color:#333;">{{ article.title }}</h1>
            <div style="color:#666; font-size:.9rem;">
                <i class="fas fa-user"></i> {{ article.author_name }}
                &nbsp;|&nbsp;
                <i class="fas fa-calendar"></i> {{ article.created_at|format_date }}
            </div>
        </header>
        <div style="line-height:1.6; margin-bottom:1.5rem; white-space:pre-wrap;">
            {{ article.content }}
        </div>
        <footer style="display:flex; justify-content:space-between; align-items:center;
                   padding-top:1rem; border-top:1px solid #eee;">
            <div style="display:flex; gap:1rem;">
                {% if user %}
                <button onclick="toggleLike({{ article.id }})" id="like-btn" style="background:none; border:none;
                         color:{% if is_liked %}#e74c3c{% else %}#666{% endif %};
                         cursor:pointer; font-size:1rem;">
                    <i class="fas fa-heart"></i> <span id="likes-count">{{ article.likes_count }}</span>
                </button>
                <button onclick="toggleSave({{ article.id }})" id="save-btn" style="background:none; border:none;
                         color:{% if is_saved %}#f39c12{% else %}#666{% endif %};
                         cursor:pointer; font-size:1rem;">
                    <i class="fas fa-bookmark"></i>
                    <span id="save-text">{% if is_saved %}Sauvegardé{% else %}Sauvegarder{% endif %}</span>
                </button>
                {% else %}
                <span style="color:#666;"><i class="fas fa-heart"></i> {{ article.likes_count }}</span>
                {% endif %}
                <span style="color:#666;"><i class="fas fa-comment"></i> {{ comments|length }}</span>
            </div>
            {% if user and article.author_id == user.id %}
            <div style="display:flex; gap:.5rem;">
                <a href="/edit-article/{{ article.id }}" style="background:#007bff; color:#fff; padding:.4rem .8rem;
                  border-radius:4px; text-decoration:none; font-size:.9rem;">
                    <i class="fas fa-edit"></i> Modifier
                </a>
                <button onclick="deleteArticle({{ article.id }})" style="background:#dc3545; color:#fff; padding:.4rem .8rem;
                       border:none; border-radius:4px; cursor:pointer; font-size:.9rem;">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </div>
            {% endif %}
        </footer>
    </div>
</article>

<section style="background:#fff; border-radius:6px; box-shadow:0 2px 5px rgba(0,0,0,0.1); padding:1.5rem;">
    <h3 style="margin-bottom:1rem;">Commentaires ({{ comments|length }})</h3>

    {% if user %}
    <form onsubmit="addComment(event, {{ article.id }})" style="margin-bottom:1.5rem;">
        <div style="display:flex; gap:.5rem;">
            <textarea name="content" placeholder="Ajoutez un commentaire..." required style="flex:1; padding:.6rem; border:1px solid #ccc; border-radius:4px;
                       resize:vertical; min-height:80px;"></textarea>
            <button type="submit" style="background:#007bff; color:#fff; border:none;
                     border-radius:4px; padding:.6rem 1rem; cursor:pointer;">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </form>
    {% endif %}

    <div id="comments-list">
        {% for comment in comments %}
        <div style="border-bottom:1px solid #eee; padding:1rem 0;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem;">
                <strong>{{ comment.author_name }}</strong>
                <small style="color:#666;">{{ comment.created_at|format_date }}</small>
            </div>
            <p style="line-height:1.5;">{{ comment.content }}</p>
        </div>
        {% endfor %}
    </div>

    {% if comments|length == 0 %}
    <p style="text-align:center; color:#666;">Aucun commentaire pour le moment.</p>
    {% endif %}
</section>


<!-- page‐specific CSS must live inside a <style> tag -->
<style>
    /* if you had any additional CSS, put it in here */
</style>

<!-- page‐specific JS must live inside a <script> tag -->
<script>
    function toggleLike(articleId) {
        fetch('/like-article/' + articleId, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const btn = document.getElementById('like-btn');
                    document.getElementById('likes-count').textContent = data.likes_count;
                    btn.style.color = data.liked ? '#e74c3c' : '#666';
                } else {
                    alert('Erreur: ' + data.error);
                }
            });
    }

    function toggleSave(articleId) {
        fetch('/save-article/' + articleId, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const btn = document.getElementById('save-btn');
                    const txt = document.getElementById('save-text');
                    btn.style.color = data.saved ? '#f39c12' : '#666';
                    txt.textContent = data.saved ? 'Sauvegardé' : 'Sauvegarder';
                } else {
                    alert('Erreur: ' + data.error);
                }
            });
    }

    function deleteArticle(articleId) {
        if (!confirm('Êtes-vous sûr de Supprimer cet Article ?')) return;
        fetch('/delete-article/' + articleId, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) window.location.href = '/';
                else alert('Erreur: ' + data.error);
            });
    }

    function addComment(event, articleId) {
        event.preventDefault();
        const form = event.target;
        const content = form.content.value.trim();
        if (!content) return alert('Veuillez saisir un commentaire');

        // build x-www-form-urlencoded body
        const body = new URLSearchParams({ content });

        fetch('/comment-article/' + articleId, {
            method: 'POST',
            headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: body.toString()
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
            // update the comments list in-place instead of reload if you want…
            location.reload();
            } else {
            alert(data.error);
            }
        })
        .catch(() => alert('Erreur de connexion'));
    }
</script>
{% endblock %}