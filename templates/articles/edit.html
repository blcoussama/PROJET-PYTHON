{% extends "base.html" %}

{% block content %}
<style>
    /* Enhanced Article Edit Styles */
    .article-container {
        max-width: 700px;
        margin: 0 auto;
        animation: slideUp 0.6s ease-out;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .edit-form {
        background: var(--card-background);
        padding: 2.5rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border-color);
        position: relative;
        overflow: hidden;
    }

    .edit-form::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--warning-color), #764ba2, var(--warning-color));
        background-size: 200% 100%;
        animation: gradientMove 3s ease-in-out infinite;
    }

    @keyframes gradientMove {
        0%, 100% { background-position: 0% 0%; }
        50% { background-position: 100% 0%; }
    }

    .edit-form h2 {
        margin-bottom: 2rem;
        text-align: center;
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--text-color);
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
    }

    .edit-form h2::after {
        content: '';
        position: absolute;
        bottom: -0.5rem;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 3px;
        background: linear-gradient(90deg, var(--warning-color), #764ba2);
        border-radius: 2px;
    }

    .form-group {
        margin-bottom: 1.5rem;
        position: relative;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text-color);
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-group label i {
        color: var(--primary-color);
        width: 16px;
    }

    .form-control {
        width: 100%;
        padding: 0.8rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: 1rem;
        transition: var(--transition);
        background: var(--card-background);
        position: relative;
        font-family: inherit;
        box-sizing: border-box;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        transform: translateY(-2px);
    }

    textarea.form-control {
        resize: vertical;
        min-height: 120px;
        line-height: 1.6;
    }

    .content-textarea {
        min-height: 200px;
    }

    /* Current image display */
    .current-image {
        margin-bottom: 1rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .current-image img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
    }

    .current-image-info {
        flex: 1;
    }

    .current-image-info h4 {
        margin: 0 0 0.5rem 0;
        font-size: 0.9rem;
        color: var(--text-color);
    }

    .current-image-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .current-image-actions a,
    .current-image-actions button {
        color: var(--primary-color);
        text-decoration: none;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        transition: var(--transition);
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }

    .current-image-actions a:hover {
        color: var(--primary-dark);
        background: rgba(0, 123, 255, 0.1);
    }

    .current-image-actions .remove-current-image {
        color: var(--danger-color);
    }

    .current-image-actions .remove-current-image:hover {
        color: #c82333;
        background: rgba(220, 53, 69, 0.1);
    }

    /* File input styling */
    .file-input {
        width: 100%;
        padding: 0.8rem 1rem;
        border: 2px dashed var(--border-color);
        border-radius: var(--border-radius);
        background: #f8f9fa;
        transition: var(--transition);
        box-sizing: border-box;
    }

    .file-input:hover {
        border-color: var(--primary-color);
        background: rgba(0, 123, 255, 0.05);
    }

    .file-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    /* Button styles */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        text-decoration: none;
        font-size: 1rem;
        font-weight: 600;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
        flex: 1;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        box-shadow: var(--shadow-md);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, var(--primary-dark), #004085);
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
        background: linear-gradient(135deg, var(--secondary-color), #5a6268);
        color: white;
        box-shadow: var(--shadow-md);
    }

    .btn-secondary:hover {
        background: linear-gradient(135deg, #5a6268, #495057);
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
        color: white;
    }

    .button-group {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }

    .alert {
        padding: 1rem;
        border-radius: var(--border-radius);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        animation: alertSlide 0.3s ease-out;
    }

    @keyframes alertSlide {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .alert-warning {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        color: #856404;
        border-left: 4px solid var(--warning-color);
    }

    /* Character counter */
    .char-counter {
        position: absolute;
        bottom: 0.5rem;
        right: 0.75rem;
        font-size: 0.8rem;
        color: var(--text-muted);
        background: rgba(255, 255, 255, 0.9);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        pointer-events: none;
    }

    .char-counter.warning {
        color: var(--warning-color);
    }

    .char-counter.danger {
        color: var(--danger-color);
    }

    /* Loading state */
    .btn.loading {
        pointer-events: none;
        opacity: 0.8;
    }

    .btn.loading::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Image removal confirmation */
    .image-removal-notice {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        color: #856404;
        padding: 0.75rem;
        border-radius: var(--border-radius);
        margin-top: 0.5rem;
        display: none;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        border-left: 4px solid var(--warning-color);
    }

    .image-removal-notice.show {
        display: flex;
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .edit-form {
            padding: 2rem 1.5rem;
            margin: 1rem;
        }

        .edit-form h2 {
            font-size: 1.5rem;
        }

        .article-container {
            max-width: 100%;
        }

        .button-group {
            flex-direction: column;
        }

        .current-image {
            flex-direction: column;
            text-align: center;
        }

        .current-image-actions {
            justify-content: center;
        }
    }

    @media (max-width: 480px) {
        .edit-form {
            padding: 1.5rem 1rem;
        }

        .edit-form h2 {
            font-size: 1.3rem;
            flex-direction: column;
            gap: 0.5rem;
        }
    }

    /* Focus styles for accessibility */
    .btn:focus,
    .form-control:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3);
    }
</style>

<div class="article-container">
    <h2 style="margin-bottom: 1.5rem; text-align: center;">
        <i class="fas fa-edit"></i>
        Modifier l'article
    </h2>

    <!-- Preserved original form structure with enhanced styling -->
    <form method="POST" action="/edit-article/{{ article.id }}" enctype="multipart/form-data" class="edit-form" id="editForm">

        <!-- Alert for editing mode -->
        <div class="alert alert-warning">
            <i class="fas fa-info-circle"></i>
            Vous modifiez un article existant. Les changements seront sauvegardés.
        </div>

        <!-- Hidden field to indicate image removal -->
        <input type="hidden" id="remove_image" name="remove_image" value="false">

        <!-- Champ "Titre" pré-rempli (preserved original logic) -->
        <div class="form-group">
            <label for="title">
                <i class="fas fa-heading"></i>
                Titre
            </label>
            <input type="text" id="title" name="title" class="form-control" required 
                   value="{{ article.title }}" placeholder="Entrez le titre de votre article" maxlength="200">
            <div class="char-counter" id="titleCounter">0/200</div>
        </div>

        <!-- Champ "Description" pré-rempli (preserved original logic) -->
        <div class="form-group">
            <label for="description">
                <i class="fas fa-align-left"></i>
                Description (optionnelle)
            </label>
            <textarea id="description" name="description" class="form-control" rows="3"
                      placeholder="Ajoutez une brève description de votre article..." maxlength="500">{{ article.description or "" }}</textarea>
            <div class="char-counter" id="descCounter">0/500</div>
        </div>

        <!-- CHAMP "Upload d'image" (preserved original logic with enhanced UI) -->
        <div class="form-group">
            <label for="image">
                <i class="fas fa-image"></i>
                Remplacer l'image (optionnel)
            </label>

            {% if article.image_filename %}
            <div class="current-image" id="currentImageContainer">
                <img src="/static/{{ article.image_filename }}" alt="Image actuelle">
                <div class="current-image-info">
                    <h4><i class="fas fa-image"></i> Image actuelle</h4>
                    <div class="current-image-actions">
                        <a href="/static/{{ article.image_filename }}" target="_blank">
                            <i class="fas fa-external-link-alt"></i>
                            Voir en grand
                        </a>
                        <button type="button" class="remove-current-image" id="removeCurrentImage">
                            <i class="fas fa-trash-alt"></i>
                            Supprimer l'image
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="image-removal-notice" id="imageRemovalNotice">
                <i class="fas fa-exclamation-triangle"></i>
                L'image sera supprimée lors de la sauvegarde.
                <button type="button" id="undoImageRemoval" style="margin-left: auto; background: none; border: none; color: #856404; text-decoration: underline; cursor: pointer;">
                    Annuler
                </button>
            </div>

            <input type="file" id="image" name="image" class="file-input" 
                   accept=".png,.jpg,.jpeg,image/png,image/jpeg">
        </div>

        <!-- Champ "Contenu" pré-rempli (preserved original logic) -->
        <div class="form-group">
            <label for="content">
                <i class="fas fa-file-alt"></i>
                Contenu
            </label>
            <textarea id="content" name="content" class="form-control content-textarea" rows="10" required
                      placeholder="Rédigez le contenu de votre article..." maxlength="10000">{{ article.content }}</textarea>
            <div class="char-counter" id="contentCounter">0/10000</div>
        </div>

        <!-- Boutons "Enregistrer" / "Annuler" (preserved original structure with enhanced styling) -->
        <div class="button-group">
            <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="fas fa-save"></i> Enregistrer
            </button>
            <a href="/article/{{ article.id }}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Annuler
            </a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('editForm');
    const submitBtn = document.getElementById('submitBtn');
    const removeCurrentImageBtn = document.getElementById('removeCurrentImage');
    const currentImageContainer = document.getElementById('currentImageContainer');
    const imageRemovalNotice = document.getElementById('imageRemovalNotice');
    const undoImageRemovalBtn = document.getElementById('undoImageRemoval');
    const removeImageField = document.getElementById('remove_image');

    // Character counters
    const counters = [
        { input: 'title', counter: 'titleCounter', max: 200 },
        { input: 'description', counter: 'descCounter', max: 500 },
        { input: 'content', counter: 'contentCounter', max: 10000 }
    ];

    counters.forEach(({ input, counter, max }) => {
        const inputEl = document.getElementById(input);
        const counterEl = document.getElementById(counter);

        // Initialize counter with current content
        const currentLength = inputEl.value.length;
        counterEl.textContent = `${currentLength}/${max}`;
        
        // Update counter styling based on current length
        counterEl.className = 'char-counter';
        if (currentLength > max * 0.8) {
            counterEl.classList.add('warning');
        }
        if (currentLength > max * 0.95) {
            counterEl.classList.add('danger');
        }

        inputEl.addEventListener('input', function() {
            const length = this.value.length;
            counterEl.textContent = `${length}/${max}`;
            
            counterEl.className = 'char-counter';
            if (length > max * 0.8) {
                counterEl.classList.add('warning');
            }
            if (length > max * 0.95) {
                counterEl.classList.add('danger');
            }
        });
    });

    // Image removal functionality
    if (removeCurrentImageBtn) {
        removeCurrentImageBtn.addEventListener('click', function() {
            if (confirm('Êtes-vous sûr de vouloir supprimer l\'image actuelle ?')) {
                currentImageContainer.style.opacity = '0.5';
                imageRemovalNotice.classList.add('show');
                removeImageField.value = 'true';
                this.disabled = true;
                this.textContent = 'Image marquée pour suppression';
            }
        });
    }

    if (undoImageRemovalBtn) {
        undoImageRemovalBtn.addEventListener('click', function() {
            currentImageContainer.style.opacity = '1';
            imageRemovalNotice.classList.remove('show');
            removeImageField.value = 'false';
            if (removeCurrentImageBtn) {
                removeCurrentImageBtn.disabled = false;
                removeCurrentImageBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Supprimer l\'image';
            }
        });
    }

    // File input validation
    const fileInput = document.getElementById('image');
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Validate file type
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg'];
            if (!validTypes.includes(file.type)) {
                alert('Veuillez sélectionner un fichier PNG, JPG ou JPEG.');
                this.value = '';
                return;
            }

            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                alert('La taille du fichier ne doit pas dépasser 5MB.');
                this.value = '';
                return;
            }

            // If a new file is selected, cancel image removal
            if (removeImageField.value === 'true') {
                removeImageField.value = 'false';
                imageRemovalNotice.classList.remove('show');
                if (currentImageContainer) {
                    currentImageContainer.style.opacity = '1';
                }
                if (removeCurrentImageBtn) {
                    removeCurrentImageBtn.disabled = false;
                    removeCurrentImageBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Supprimer l\'image';
                }
            }
        }
    });

    // Form submission (preserved original functionality with enhanced UX)
    form.addEventListener('submit', function(e) {
        // Validate required fields
        const title = document.getElementById('title').value.trim();
        const content = document.getElementById('content').value.trim();

        if (!title || !content) {
            e.preventDefault();
            alert('Veuillez remplir tous les champs obligatoires.');
            return;
        }

        // Show loading state
        submitBtn.classList.add('loading');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement en cours...';
        submitBtn.disabled = true;
    });

    // Auto-save to localStorage for edit mode
    const autoSaveFields = ['title', 'description', 'content'];
    const articleId = '{{ article.id }}';
    
    autoSaveFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        
        // Load saved data specific to this article
        const savedValue = localStorage.getItem(`edit_article_${articleId}_${fieldId}`);
        if (savedValue && savedValue !== field.value) {
            // Show option to restore saved changes
            if (confirm(`Des modifications non sauvegardées ont été trouvées pour le champ "${fieldId}". Voulez-vous les restaurer ?`)) {
                field.value = savedValue;
                field.dispatchEvent(new Event('input'));
            }
        }

        // Save on input
        field.addEventListener('input', function() {
            localStorage.setItem(`edit_article_${articleId}_${fieldId}`, this.value);
        });
    });

    // Clear auto-save on successful submission
    form.addEventListener('submit', function() {
        setTimeout(() => {
            autoSaveFields.forEach(fieldId => {
                localStorage.removeItem(`edit_article_${articleId}_${fieldId}`);
            });
        }, 1000);
    });

    // Form validation
    const inputs = document.querySelectorAll('.form-control');
    inputs.forEach(input => {
        input.addEventListener('blur', function() {
            const formGroup = this.closest('.form-group');
            formGroup.classList.remove('has-error', 'has-success');
            
            if (this.checkValidity() && this.value.trim()) {
                formGroup.classList.add('has-success');
            } else if (!this.checkValidity()) {
                formGroup.classList.add('has-error');
            }
        });

        input.addEventListener('focus', function() {
            const formGroup = this.closest('.form-group');
            formGroup.classList.remove('has-error', 'has-success');
        });
    });
});
</script>
{% endblock %}